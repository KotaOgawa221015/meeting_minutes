<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIË≠∞‰∫ãÈå≤ - Èå≤Èü≥‰∏≠</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .app {
            display: flex;
            height: 100vh;
        }
        
        aside {
            width: 280px;
            background: #667eea;
            color: white;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 35px;
        }
        .section-title {
            font-size: 13px;
            opacity: 0.7;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 600;
        }
        
        .participant-card {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .participant-card:hover {
            background: rgba(255,255,255,0.15);
        }
        .participant-card.speaking {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .participant-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .participant-icon {
            font-size: 24px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            flex-shrink: 0;
        }
        .participant-info {
            flex: 1;
        }
        .participant-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        .participant-role {
            font-size: 12px;
            opacity: 0.8;
        }
        .participant-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-left: auto;
            flex-shrink: 0;
        }
        .participant-status.inactive {
            background: #6b7280;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header strong {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }
        header small {
            color: #666;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn.primary {
            background: #10b981;
            color: white;
        }
        .btn.primary:hover {
            background: #059669;
        }
        .btn.danger {
            background: #ef4444;
            color: white;
        }
        .btn.danger:hover {
            background: #dc2626;
        }
        .btn.back {
            background: transparent;
            color: #374151;
            border: 1px solid #e5e7eb;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        .btn.back:hover {
            background: #f3f4f6;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
            height: calc(100vh - 90px);
        }
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            padding: 15px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title {
            flex: 1;
        }
        .panel-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .talk {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .bubble {
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            background: #f9fafb;
        }
        .bubble.human {
            border-left-color: #3b82f6;
        }
        .bubble.ai {
            border-left-color: #8b5cf6;
            background: #faf5ff;
        }
        .bubble.facilitator {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }
        .speaker {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .timestamp {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .right {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-bottom: 10px;
        }
        .right .panel {
            flex-shrink: 0;
        }
        .right .panel-body ul {
            list-style: none;
        }
        .right .panel-body li {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .right .panel-body li:last-child {
            border-bottom: none;
        }
        .right .panel-body p {
            margin-bottom: 10px;
        }
        
        .timer {
            text-align: center;
        }
        .time {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .add-panel-btn {
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            flex-shrink: 0;
        }
        .add-panel-btn:hover {
            border-color: #667eea;
            background: #f9fafb;
            color: #667eea;
        }
        .add-panel-btn.expanded {
            display: none;
        }
        .plus-icon {
            font-size: 24px;
        }
        
        .feature-selector {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            border: 3px solid #667eea;
        }
        .feature-selector.active {
            display: flex;
            flex-direction: column;
        }
        .feature-selector-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            font-weight: 600;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }
        .feature-selector-body {
            padding: 15px;
            background: rgba(255,255,255,0.1);
        }
        .feature-grid {
            display: grid;
            gap: 10px;
        }
        .feature-card {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.95);
        }
        .feature-card:hover {
            border-color: white;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .feature-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .feature-info {
            flex: 1;
        }
        .feature-name {
            font-weight: 700;
            margin-bottom: 4px;
            color: #1f2937;
            font-size: 15px;
        }
        .feature-desc {
            font-size: 13px;
            color: #6b7280;
        }
        .close-selector-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            cursor: pointer;
            color: white;
            font-size: 20px;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: bold;
        }
        .close-selector-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .panel-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .panel-close:hover {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .timer-settings {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .timer-settings.collapsed {
            display: none;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        .input-group input {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .toggle-settings-btn {
            background: #f3f4f6;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .toggle-settings-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        .toggle-settings-btn .arrow {
            transition: transform 0.3s;
        }
        .toggle-settings-btn.collapsed .arrow {
            transform: rotate(180deg);
        }
        .timer-display {
            text-align: center;
            margin: 20px 0;
        }
        .timer-display.compact {
            margin: 10px 0;
        }
        .timer-time {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            font-variant-numeric: tabular-nums;
        }
        .timer-time.warning {
            color: #f59e0b;
        }
        .timer-time.danger {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .timer-controls .btn {
            flex: 1;
            min-width: 80px;
        }
        
        .visualizer-container {
            height: 80px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
        
        .input-container {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .manual-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }
        .manual-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn.send {
            background: #667eea;
            color: white;
            padding: 12px 20px;
        }
        .btn.send:hover {
            background: #5568d3;
        }
        .btn.send:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .bubble-actions {
            display: none;
            gap: 8px;
            margin-top: 10px;
        }
        .bubble:hover .bubble-actions {
            display: flex;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        .btn-edit:hover {
            background: #2563eb;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        .btn-delete:hover {
            background: #dc2626;
        }
        .btn-save {
            background: #10b981;
            color: white;
        }
        .btn-save:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #6b7280;
            color: white;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        .edit-textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .empty-state {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .summary-detail {
            display: none;
            margin-top: 20px;
        }
        .summary-detail.active {
            display: block;
        }
        .summary-content {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        .summary-content h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #333;
        }
        .summary-content h4:first-child {
            margin-top: 0;
        }
        .action-item {
            background: #fef3c7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #f59e0b;
        }
        
        @media (max-width: 1024px) {
            aside {
                width: 200px;
            }
            .content {
                grid-template-columns: 1fr;
            }
            .right {
                flex-direction: row;
                overflow-x: auto;
            }
            .right .panel {
                min-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside>
            <div class="logo">ü§ñ AIË≠∞‰∫ãÈå≤</div>
            
            <div class="section">
                <div class="section-title">üë• ÂèÇÂä†ËÄÖ</div>
                
                <div class="participant-card" id="facilitatorCard">
                    <div class="participant-header">
                        <div class="participant-icon">üß≠</div>
                        <div class="participant-info">
                            <div class="participant-name">AI„Éï„Ç°„Ç∑„É™„ÉÜ„Éº„Çø„Éº</div>
                            <div class="participant-role">‰ºöË≠∞ÈÄ≤Ë°å„ÉªË≠∞‰∫ãÈå≤‰ΩúÊàê</div>
                        </div>
                        <span class="participant-status"></span>
                    </div>
                </div>
                
                <div class="participant-card">
                    <div class="participant-header">
                        <div class="participant-icon">üìù</div>
                        <div class="participant-info">
                            <div class="participant-name">AIÊõ∏Ë®ò</div>
                            <div class="participant-role">„É™„Ç¢„É´„Çø„Ç§„É†ÊñáÂ≠óËµ∑„Åì„Åó</div>
                        </div>
                        <span class="participant-status"></span>
                    </div>
                </div>
                
                <div class="participant-card">
                    <div class="participant-header">
                        <div class="participant-icon">üìä</div>
                        <div class="participant-info">
                            <div class="participant-name">AI„Ç¢„Éä„É™„Çπ„Éà</div>
                            <div class="participant-role">Ë¶ÅÁ¥Ñ„ÉªÂàÜÊûê</div>
                        </div>
                        <span class="participant-status"></span>
                    </div>
                </div>
                
                <div id="humanParticipants"></div>
            </div>
            
            <div class="section">
                <div class="section-title">üìà Áµ±Ë®à</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statDuration">00:00</div>
                        <div class="stat-label">ÁµåÈÅéÊôÇÈñì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTranscripts">0</div>
                        <div class="stat-label">Áô∫Ë®ÄÊï∞</div>
                    </div>
                </div>
            </div>
        </aside>

        <main>
            <header>
                <div>
                    <strong id="meetingTitle">ÂÆö‰æã„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞</strong><br />
                    <small id="statusText">Ê∫ñÂÇôÂÆå‰∫Ü</small>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <a href="#" class="btn back" id="backBtn">Êàª„Çã</a>
                    <button class="btn primary" id="startBtn">Èå≤Èü≥ÈñãÂßã</button>
                </div>
            </header>

            <div class="content">
                <section class="panel">
                    <div class="panel-header">üìù ÊñáÂ≠óËµ∑„Åì„Åó(„É™„Ç¢„É´„Çø„Ç§„É†)</div>
                    <div class="panel-body talk" id="transcriptArea">
                        <div class="empty-state">Èå≤Èü≥„ÇíÈñãÂßã„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÊñáÂ≠óËµ∑„Åì„Åó„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
                    </div>
                    <div class="visualizer-container">
                        <canvas id="visualizer"></canvas>
                    </div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <input 
                                type="text" 
                                class="manual-input" 
                                id="manualInput" 
                                placeholder="„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ..."
                            />
                            <button class="btn send" id="sendBtn">ÈÄÅ‰ø°</button>
                        </div>
                    </div>
                </section>

                <div class="right" id="rightPanels">
                    <section class="panel">
                        <div class="panel-header">üß≠ AI„Éï„Ç°„Ç∑„É™„ÉÜ„Éº„Ç∑„Éß„É≥</div>
                        <div class="panel-body" id="facilitationContent">
                            <p><strong>Áä∂ÊÖã:</strong>ÂæÖÊ©ü‰∏≠</p>
                        </div>
                    </section>

                    <section class="panel">
                        <div class="panel-header">üìã Ë¶ÅÁ¥Ñ(„É™„Ç¢„É´„Çø„Ç§„É†)</div>
                        <div class="panel-body" id="summaryContent">
                            <ul id="summaryList">
                                <li style="color: #9ca3af;">‰ºöË≠∞ÈñãÂßãÂæå„ÄÅË¶ÅÁ¥Ñ„ÇíÁîüÊàê„Åó„Åæ„Åô</li>
                            </ul>
                            <div class="summary-detail" id="summarySection"></div>
                        </div>
                    </section>
                    
                    <div class="feature-selector" id="featureSelector">
                        <div class="feature-selector-header">
                            <span>Ê©üËÉΩ„ÇíËøΩÂä†</span>
                            <button class="close-selector-btn" id="closeSelectorBtn">√ó</button>
                        </div>
                        <div class="feature-selector-body">
                            <div class="feature-grid" id="featureList"></div>
                        </div>
                    </div>
                    
                    <button class="add-panel-btn" id="addPanelBtn">
                        <span class="plus-icon">‚äï</span>
                        <span>Ê©üËÉΩ„ÇíËøΩÂä†</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const pathParts = window.location.pathname.split('/');
        const meetingId = pathParts[pathParts.indexOf('meeting') + 1] || 1;
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/meeting/${meetingId}/`;
        
        console.log('Meeting ID:', meetingId);
        console.log('WebSocket URL:', wsUrl);
        
        let socket = null;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let isRecording = false;
        let transcriptCount = 0;

        const startBtn = document.getElementById('startBtn');
        const transcriptArea = document.getElementById('transcriptArea');
        const statusText = document.getElementById('statusText');
        const summarySection = document.getElementById('summarySection');
        const statDuration = document.getElementById('statDuration');
        const statTranscripts = document.getElementById('statTranscripts');
        const manualInput = document.getElementById('manualInput');
        const sendBtn = document.getElementById('sendBtn');
        const addPanelBtn = document.getElementById('addPanelBtn');
        const featureSelector = document.getElementById('featureSelector');
        const closeSelectorBtn = document.getElementById('closeSelectorBtn');
        const rightPanels = document.getElementById('rightPanels');
        
        let transcriptItems = [];
        let panelIdCounter = 0;
        let activePanels = {};

        const availableFeatures = [
            {
                id: 'timekeeper',
                name: '„Çø„Ç§„É†„Ç≠„Éº„Éë„Éº',
                icon: '‚è±Ô∏è',
                description: '‰ºöË≠∞„ÅÆÁµåÈÅéÊôÇÈñì„ÇíË®àÊ∏¨',
                create: createTimekeeperPanel
            },
            {
                id: 'timer',
                name: '„Ç´„Çπ„Çø„É†„Çø„Ç§„Éû„Éº',
                icon: '‚è∞',
                description: 'ÊôÇÈñìË®≠ÂÆöÂèØËÉΩ„Å™„Çø„Ç§„Éû„Éº',
                create: createTimerPanel
            }
        ];

        function showAddFeatureModal() {
            const featureList = document.getElementById('featureList');
            featureList.innerHTML = '';
            
            availableFeatures.forEach(feature => {
                const card = document.createElement('div');
                card.className = 'feature-card';
                card.innerHTML = `
                    <div class="feature-icon">${feature.icon}</div>
                    <div class="feature-info">
                        <div class="feature-name">${feature.name}</div>
                        <div class="feature-desc">${feature.description}</div>
                    </div>
                `;
                card.onclick = () => {
                    addFeature(feature);
                    hideAddFeatureModal();
                };
                featureList.appendChild(card);
            });
            
            featureSelector.classList.add('active');
            addPanelBtn.classList.add('expanded');
        }

        function hideAddFeatureModal() {
            featureSelector.classList.remove('active');
            addPanelBtn.classList.remove('expanded');
        }

        function addFeature(feature) {
            const panelId = `panel-${feature.id}-${panelIdCounter++}`;
            const panel = feature.create(panelId);
            
            rightPanels.insertBefore(panel, featureSelector);
        }

        function removePanel(panelId) {
            if (activePanels[panelId]) {
                if (activePanels[panelId].cleanup) {
                    activePanels[panelId].cleanup();
                }
                
                activePanels[panelId].element.remove();
                delete activePanels[panelId];
            }
        }

        function createTimekeeperPanel(panelId) {
            const panel = document.createElement('section');
            panel.className = 'panel';
            panel.id = panelId;
            
            const header = document.createElement('div');
            header.className = 'panel-header';
            header.innerHTML = `<span class="panel-title">‚è±Ô∏è „Çø„Ç§„É†„Ç≠„Éº„Éë„Éº</span>`;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'panel-close';
            closeBtn.textContent = '√ó';
            closeBtn.onclick = () => removePanel(panelId);
            header.appendChild(closeBtn);
            
            const body = document.createElement('div');
            body.className = 'panel-body timer';
            
            const timekeeperData = {
                interval: null,
                seconds: 0,
                isRunning: false
            };
            
            body.innerHTML = `<function_calls>
                                <invoke name="artifacts">
                                <parameter name="command">update</parameter>
                                <parameter name="id">artifact_1</parameter>
                                <parameter name="old_str">            
                                body.innerHTML = </parameter> <parameter name="new_str">
                                body.innerHTML = 
                                <div class="time" id="timekeeper-display-${panelId}">00:00</div>
                                <div class="controls">
                                <button class="btn primary timekeeper-start">ÈñãÂßã</button>
                                <button class="btn danger timekeeper-stop">ÂÅúÊ≠¢</button>
                                </div>
                                `;
                                panel.appendChild(header);
        panel.appendChild(body);
        
        const timeDisplay = body.querySelector(`#timekeeper-display-${panelId}`);
        const startTimerBtn = body.querySelector('.timekeeper-start');
        const stopTimerBtn = body.querySelector('.timekeeper-stop');
        
        function updateDisplay() {
            const minutes = Math.floor(timekeeperData.seconds / 60);
            const seconds = timekeeperData.seconds % 60;
            timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            statDuration.textContent = timeDisplay.textContent;
        }
        
        function startTimekeeper() {
            if (timekeeperData.isRunning) return;
            
            timekeeperData.isRunning = true;
            timekeeperData.interval = setInterval(() => {
                timekeeperData.seconds++;
                updateDisplay();
            }, 1000);
            
            startTimerBtn.disabled = true;
            stopTimerBtn.disabled = false;
        }
        
        function stopTimekeeper() {
            if (!timekeeperData.isRunning) return;
            
            clearInterval(timekeeperData.interval);
            timekeeperData.isRunning = false;
            
            startTimerBtn.disabled = false;
            stopTimerBtn.disabled = true;
        }
        
        startTimerBtn.addEventListener('click', startTimekeeper);
        stopTimerBtn.addEventListener('click', stopTimekeeper);
        
        stopTimerBtn.disabled = true;
        
        activePanels[panelId] = {
            element: panel,
            cleanup: () => {
                if (timekeeperData.interval) {
                    clearInterval(timekeeperData.interval);
                }
            }
        };
        
        return panel;
    }

    function createTimerPanel(panelId) {
        const panel = document.createElement('section');
        panel.className = 'panel';
        panel.id = panelId;
        
        const header = document.createElement('div');
        header.className = 'panel-header';
        header.innerHTML = `<span class="panel-title">‚è∞ „Ç´„Çπ„Çø„É†„Çø„Ç§„Éû„Éº</span>`;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'panel-close';
        closeBtn.textContent = '√ó';
        closeBtn.onclick = () => removePanel(panelId);
        header.appendChild(closeBtn);
        
        const body = document.createElement('div');
        body.className = 'panel-body';
        
        const timerData = {
            targetMinutes: 25,
            targetSeconds: 0,
            currentSeconds: 0,
            interval: null,
            isRunning: false,
            isPaused: false
        };
        
        body.innerHTML = `
            <button class="toggle-settings-btn" id="toggle-${panelId}">
                <span class="arrow">‚ñº</span>
                <span class="toggle-text">ÊôÇÈñìË®≠ÂÆö„ÇíÈö†„Åô</span>
            </button>
            <div class="timer-settings" id="settings-${panelId}">
                <div class="input-group">
                    <label>ÁõÆÊ®ôÊôÇÈñì (ÂàÜ)</label>
                    <input type="number" class="timer-minutes" value="25" min="0" max="999">
                </div>
                <div class="input-group">
                    <label>ÁõÆÊ®ôÊôÇÈñì (Áßí)</label>
                    <input type="number" class="timer-seconds" value="0" min="0" max="59">
                </div>
            </div>
            <div class="timer-display" id="display-${panelId}">
                <div class="timer-time">25:00</div>
            </div>
            <div class="timer-controls">
                <button class="btn primary timer-start">ÈñãÂßã</button>
                <button class="btn timer-pause" style="display:none;">‰∏ÄÊôÇÂÅúÊ≠¢</button>
                <button class="btn danger timer-reset">„É™„Çª„ÉÉ„Éà</button>
            </div>
        `;
        
        panel.appendChild(header);
        panel.appendChild(body);
        
        const toggleBtn = body.querySelector(`#toggle-${panelId}`);
        const toggleText = toggleBtn.querySelector('.toggle-text');
        const settingsDiv = body.querySelector(`#settings-${panelId}`);
        const displayDiv = body.querySelector(`#display-${panelId}`);
        const minutesInput = body.querySelector('.timer-minutes');
        const secondsInput = body.querySelector('.timer-seconds');
        const timeDisplay = body.querySelector('.timer-time');
        const startTimerBtn = body.querySelector('.timer-start');
        const pauseBtn = body.querySelector('.timer-pause');
        const resetBtn = body.querySelector('.timer-reset');
        
        let settingsCollapsed = false;
        
        toggleBtn.addEventListener('click', () => {
            settingsCollapsed = !settingsCollapsed;
            if (settingsCollapsed) {
                settingsDiv.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleText.textContent = 'ÊôÇÈñìË®≠ÂÆö„ÇíË°®Á§∫';
            } else {
                settingsDiv.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleText.textContent = 'ÊôÇÈñìË®≠ÂÆö„ÇíÈö†„Åô';
            }
        });
        
        function updateDisplay() {
            const totalSeconds = timerData.targetMinutes * 60 + timerData.targetSeconds - timerData.currentSeconds;
            const mins = Math.floor(Math.abs(totalSeconds) / 60);
            const secs = Math.abs(totalSeconds) % 60;
            const sign = totalSeconds < 0 ? '-' : '';
            
            timeDisplay.textContent = `${sign}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            
            timeDisplay.className = 'timer-time';
            const remaining = totalSeconds;
            if (remaining < 0) {
                timeDisplay.classList.add('danger');
            } else if (remaining < 60) {
                timeDisplay.classList.add('warning');
            }
        }
        
        function startTimer() {
            if (timerData.isRunning) return;
            
            if (!timerData.isPaused) {
                timerData.targetMinutes = parseInt(minutesInput.value) || 0;
                timerData.targetSeconds = parseInt(secondsInput.value) || 0;
                timerData.currentSeconds = 0;
            }
            
            timerData.isRunning = true;
            timerData.isPaused = false;
            
            timerData.interval = setInterval(() => {
                timerData.currentSeconds++;
                updateDisplay();
                
                const totalSeconds = timerData.targetMinutes * 60 + timerData.targetSeconds;
                if (timerData.currentSeconds === totalSeconds) {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('„Çø„Ç§„Éû„ÉºÁµÇ‰∫Ü', {
                            body: '„Ç´„Çπ„Çø„É†„Çø„Ç§„Éû„Éº„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü'
                        });
                    }
                }
            }, 1000);
            
            if (!settingsCollapsed) {
                settingsDiv.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleText.textContent = 'ÊôÇÈñìË®≠ÂÆö„ÇíË°®Á§∫';
                settingsCollapsed = true;
            }
            
            displayDiv.classList.add('compact');
            startTimerBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
            pauseBtn.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
        }
        
        function pauseTimer() {
            if (!timerData.isRunning) return;
            
            clearInterval(timerData.interval);
            timerData.isRunning = false;
            timerData.isPaused = true;
            
            pauseBtn.textContent = 'ÂÜçÈñã';
            pauseBtn.onclick = startTimer;
        }
        
        function resetTimer() {
            clearInterval(timerData.interval);
            timerData.isRunning = false;
            timerData.isPaused = false;
            timerData.currentSeconds = 0;
            
            updateDisplay();
            
            settingsDiv.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            toggleText.textContent = 'ÊôÇÈñìË®≠ÂÆö„ÇíÈö†„Åô';
            settingsCollapsed = false;
            
            displayDiv.classList.remove('compact');
            startTimerBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
            pauseBtn.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
            pauseBtn.onclick = pauseTimer;
        }
        
        minutesInput.addEventListener('input', () => {
            if (!timerData.isRunning && !timerData.isPaused) {
                timerData.targetMinutes = parseInt(minutesInput.value) || 0;
                updateDisplay();
            }
        });
        
        secondsInput.addEventListener('input', () => {
            if (!timerData.isRunning && !timerData.isPaused) {
                timerData.targetSeconds = parseInt(secondsInput.value) || 0;
                updateDisplay();
            }
        });
        
        startTimerBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        
        activePanels[panelId] = {
            element: panel,
            cleanup: () => {
                if (timerData.interval) {
                    clearInterval(timerData.interval);
                }
            }
        };
        
        return panel;
    }

    function connectWebSocket() {
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            console.log('WebSocketÊé•Á∂öÊàêÂäü');
            statusText.textContent = 'Êé•Á∂öÂÆå‰∫Ü - Èå≤Èü≥Ê∫ñÂÇôÂÆå‰∫Ü';
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('WebSocket message:', data);
            
            if (data.type === 'transcript') {
                addTranscript(data.text);
                transcriptCount++;
                statTranscripts.textContent = transcriptCount;
            } else if (data.type === 'summary_complete') {
                displaySummary(data.summary);
            } else if (data.type === 'error') {
                alert('„Ç®„É©„Éº: ' + data.message);
            }
        };

        socket.onerror = (error) => {
            console.error('WebSocket„Ç®„É©„Éº:', error);
            statusText.textContent = '„Ç®„É©„Éº: Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        };

        socket.onclose = () => {
            console.log('WebSocketÊé•Á∂öÁµÇ‰∫Ü');
        };
    }

    async function startRecording() {
        if (isRecording) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                } 
            });

            setupVisualizer(stream);

            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm'
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && socket && socket.readyState === WebSocket.OPEN) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        socket.send(JSON.stringify({
                            type: 'audio_chunk',
                            audio: base64Audio
                        }));
                    };
                    reader.readAsDataURL(event.data);
                }
            };

            mediaRecorder.start(500);
            isRecording = true;

            startBtn.textContent = 'Èå≤Èü≥ÂÅúÊ≠¢';
            startBtn.className = 'btn danger';
            statusText.textContent = 'Èå≤Èü≥‰∏≠...';
            transcriptArea.innerHTML = '';

        } catch (error) {
            console.error('„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº:', error);
            alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
    }

    function stopRecording() {
        if (!isRecording) return;
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;

            startBtn.textContent = 'Èå≤Èü≥ÈñãÂßã';
            startBtn.className = 'btn primary';
            statusText.textContent = 'Èå≤Èü≥ÂÅúÊ≠¢ - Ë≠∞‰∫ãÈå≤„ÇíÁîüÊàê‰∏≠...';

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'stop_recording'
                }));
            }

            summarySection.classList.add('active');
        }
    }

    function addTranscript(text) {
        const id = Date.now();
        const item = document.createElement('div');
        item.className = 'bubble human';
        item.dataset.id = id;
        
        const speaker = document.createElement('div');
        speaker.className = 'speaker';
        speaker.textContent = 'üë§ ÂèÇÂä†ËÄÖ';
        
        const content = document.createElement('div');
        content.className = 'transcript-content';
        content.textContent = text;
        
        const timestamp = document.createElement('div');
        timestamp.className = 'timestamp';
        timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
        
        const actions = document.createElement('div');
        actions.className = 'bubble-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-small btn-edit';
        editBtn.textContent = 'Á∑®ÈõÜ';
        editBtn.onclick = () => editTranscript(id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-small btn-delete';
        deleteBtn.textContent = 'ÂâäÈô§';
        deleteBtn.onclick = () => deleteTranscript(id);
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(speaker);
        item.appendChild(content);
        item.appendChild(timestamp);
        item.appendChild(actions);
        
        transcriptArea.appendChild(item);
        transcriptArea.scrollTop = transcriptArea.scrollHeight;
        
        transcriptItems.push({ id, text, timestamp: new Date() });
        
        const facilitatorCard = document.getElementById('facilitatorCard');
        facilitatorCard.classList.add('speaking');
        setTimeout(() => {
            facilitatorCard.classList.remove('speaking');
        }, 2000);
    }
    
    function addManualTranscript() {
        const text = manualInput.value.trim();
        if (!text) return;
        
        addTranscript(text);
        manualInput.value = '';
        transcriptCount++;
        statTranscripts.textContent = transcriptCount;
    }
    
    function editTranscript(id) {
        const bubble = document.querySelector(`[data-id="${id}"]`);
        if (!bubble) return;
        
        const content = bubble.querySelector('.transcript-content');
        const actions = bubble.querySelector('.bubble-actions');
        const originalText = content.textContent;
        
        const textarea = document.createElement('textarea');
        textarea.className = 'edit-textarea';
        textarea.value = originalText;
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn-small btn-save';
        saveBtn.textContent = '‰øùÂ≠ò';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-small btn-cancel';
        cancelBtn.textContent = '„Ç≠„É£„É≥„Çª„É´';
        
        saveBtn.onclick = () => {
            const newText = textarea.value.trim();
            if (newText) {
                content.textContent = newText;
                const item = transcriptItems.find(t => t.id === id);
                if (item) item.text = newText;
            }
            content.style.display = 'block';
            textarea.remove();
            actions.innerHTML = '';
            actions.appendChild(createEditButton(id));
            actions.appendChild(createDeleteButton(id));
        };
        
        cancelBtn.onclick = () => {
            content.style.display = 'block';
            textarea.remove();
            actions.innerHTML = '';
            actions.appendChild(createEditButton(id));
            actions.appendChild(createDeleteButton(id));
        };
        
        content.style.display = 'none';
        bubble.insertBefore(textarea, actions);
        
        actions.innerHTML = '';
        actions.style.display = 'flex';
        actions.appendChild(saveBtn);
        actions.appendChild(cancelBtn);
        
        textarea.focus();
    }
    
    function deleteTranscript(id) {
        if (!confirm('„Åì„ÅÆÁô∫Ë®Ä„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) return;
        
        const bubble = document.querySelector(`[data-id="${id}"]`);
        if (bubble) {
            bubble.remove();
            transcriptItems = transcriptItems.filter(t => t.id !== id);
            transcriptCount = Math.max(0, transcriptCount - 1);
            statTranscripts.textContent = transcriptCount;
        }
    }
    
    function createEditButton(id) {
        const btn = document.createElement('button');
        btn.className = 'btn-small btn-edit';
        btn.textContent = 'Á∑®ÈõÜ';
        btn.onclick = () => editTranscript(id);
        return btn;
    }
    
    function createDeleteButton(id) {
        const btn = document.createElement('button');
        btn.className = 'btn-small btn-delete';
        btn.textContent = 'ÂâäÈô§';
        btn.onclick = () => deleteTranscript(id);
        return btn;
    }

    function displaySummary(summary) {
        let html = '<div class="summary-content">';
        html += `<h4>üìå Ë¶ÅÁ¥Ñ</h4><p>${summary.summary}</p>`;
        
        if (summary.key_points && summary.key_points.length > 0) {
            html += '<h4>üîë ÈáçË¶Å„Éù„Ç§„É≥„Éà</h4><ul style="padding-left: 20px;">';
            summary.key_points.forEach(point => {
                html += `<li>${point}</li>`;
            });
            html += '</ul>';
        }
        
        if (summary.action_items && summary.action_items.length > 0) {
            html += '<h4>‚úÖ „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†</h4>';
            summary.action_items.forEach(item => {
                html += `<div class="action-item">
                    <strong>${item.task}</strong>
                    ${item.assignee ? ` - ÊãÖÂΩì: ${item.assignee}` : ''}
                </div>`;
            });
        }
        
        if (summary.decisions && summary.decisions.length > 0) {
            html += '<h4>üìã Ê±∫ÂÆö‰∫ãÈ†Ö</h4><ul style="padding-left: 20px;">';
            summary.decisions.forEach(decision => {
                html += `<li>${decision}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
        html += '<div style="margin-top: 20px; text-align: center;">';
        html += `<a href="/meeting/${meetingId}/detail/" style="padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; display: inline-block;">Ë©≥Á¥∞„Éö„Éº„Ç∏„ÇíË¶ã„Çã</a>`;
        html += '</div>';
        
        summarySection.innerHTML = html;
        statusText.textContent = 'Ë≠∞‰∫ãÈå≤ÁîüÊàêÂÆå‰∫ÜÔºÅ';
    }

    function setupVisualizer(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;

        const canvas = document.getElementById('visualizer');
        const canvasContext = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function draw() {
            if (!isRecording) return;
            
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);

            canvasContext.fillStyle = '#f9fafb';
            canvasContext.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
                
                const gradient = canvasContext.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                
                canvasContext.fillStyle = gradient;
                canvasContext.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        draw();
    }

    startBtn.addEventListener('click', () => {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    });
    
    sendBtn.addEventListener('click', addManualTranscript);
    addPanelBtn.addEventListener('click', showAddFeatureModal);
    closeSelectorBtn.addEventListener('click', hideAddFeatureModal);
    
    manualInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addManualTranscript();
        }
    });

    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    connectWebSocket();

    window.addEventListener('beforeunload', () => {
        if (isRecording) {
            stopRecording();
        }
        if (socket) {
            socket.close();
        }
        
        Object.keys(activePanels).forEach(panelId => {
            if (activePanels[panelId].cleanup) {
                activePanels[panelId].cleanup();
            }
        });
    });
</script>