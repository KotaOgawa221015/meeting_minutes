<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ  - {{ debate.title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: rgb(255, 140, 80);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            color: rgb(255, 140, 80);
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            margin-bottom: 5px;
        }
        .header-info {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .setup-panel,
        .debate-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .setup-panel h2,
        .debate-area h2 {
            color: rgb(255, 140, 80);
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: rgb(255, 140, 80);
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .status-setup {
            background: #E8F5E9;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }
        .status-debating {
            background: #FFF3E0;
            color: #E65100;
            border-left: 4px solid #FF9800;
        }
        .status-completed {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-primary {
            background: rgb(255, 140, 80);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: rgb(245, 130, 70);
            transform: scale(1.02);
        }
        .btn-secondary {
            background: #999;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #777;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .debate-messages {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 2px solid #eee;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message.user {
            background: #E3F2FD;
            border-left: 4px solid rgb(100, 150, 200);
        }
        .message.ai {
            background: #FFE0B2;
            border-left: 4px solid rgb(255, 140, 80);
        }
        .message-speaker {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .message-text {
            color: #333;
            line-height: 1.6;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .input-group textarea {
            flex: 1;
            margin-bottom: 0;
        }
        .input-group button {
            width: 100px;
            align-self: flex-end;
        }
        .result-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .result-panel h2 {
            color: rgb(255, 140, 80);
            margin-bottom: 15px;
        }
        .winner-info {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .winner-user {
            background: #FFB6C1;
            color: #8B0000;
        }
        .winner-ai {
            background: #87CEEB;
            color: #00008B;
        }
        .winner-draw {
            background: #DDA0DD;
            color: #333;
        }
        .judgment {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
            color: #333;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .actions a,
        .actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .actions .btn-list {
            background: rgb(100, 150, 200);
            color: white;
        }
        .actions .btn-list:hover {
            background: rgb(80, 130, 180);
        }
        .actions .btn-share {
            background: #4CAF50;
            color: white;
        }
        .actions .btn-share:hover {
            background: #388E3C;
        }
        .speaking-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #FFF3E0;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .speaking-indicator.active {
            display: flex;
        }
        .voice-icon {
            font-size: 2em;
        }
        .btn-stop {
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-stop:hover {
            background: #cc0000;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .header-info {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ¤ ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ </h1>
            <p><strong>ãƒ†ãƒ¼ãƒ:</strong> {{ debate.title }}</p>
            <div class="header-info">
                <div class="info-item">
                    <strong>AIã‚¿ã‚¤ãƒ—:</strong> 
                    {% if debate.ai_type == 'logical' %}
                        è«–ç†çš„
                    {% elif debate.ai_type == 'creative' %}
                        å‰µé€ çš„
                    {% elif debate.ai_type == 'diplomatic' %}
                        å¤–äº¤çš„
                    {% else %}
                        æ”»æ’ƒçš„
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>å…ˆæ”»:</strong> 
                    {% if debate.first_speaker == 'user' %}
                        ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    {% else %}
                        ğŸ¤– AI
                    {% endif %}
                </div>
                <div class="info-item">
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
                    <span id="status-display">
                        {% if debate.status == 'setup' %}
                            ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                        {% elif debate.status == 'debating' %}
                            ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆä¸­
                        {% else %}
                            å®Œäº†
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="status-message" class="status-message status-setup">
            {% if debate.status == 'setup' %}
                ğŸ“‹ ä¸‹ã®ã€Œãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„
            {% elif debate.status == 'debating' %}
                ğŸ¤ ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãŒé€²è¡Œä¸­ã§ã™ã€‚ç™ºè¨€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            {% else %}
                âœ… ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚çµæœã‚’ã”è¦§ãã ã•ã„
            {% endif %}
        </div>

        {% if debate.status == 'completed' %}
            <!-- çµæœãƒ‘ãƒãƒ« -->
            <div class="result-panel">
                <h2>ğŸ† ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆçµæœ</h2>
                <div class="winner-info winner-{{ debate.winner }}">
                    {% if debate.winner == 'user' %}
                        ğŸ‘¤ <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹åˆ©ã—ã¾ã—ãŸï¼</strong>
                    {% elif debate.winner == 'ai' %}
                        ğŸ¤– <strong>AIãŒå‹åˆ©ã—ã¾ã—ãŸï¼</strong>
                    {% else %}
                        ğŸ¤ <strong>å¼•ãåˆ†ã‘ã§ã™ï¼</strong>
                    {% endif %}
                </div>
                <div class="judgment">
                    <strong>AIã®åˆ¤å®š:</strong><br>{{ debate.judgment_text }}
                </div>
                <div class="actions">
                    <a href="{% url 'debate_index' %}" class="btn-list">ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆä¸€è¦§ã¸</a>
                    <a href="{% url 'debate_detail' debate.id %}" class="btn-share">è©³ç´°ã‚’è¡¨ç¤º</a>
                </div>
            </div>
        {% else %}
            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="main-content">
                <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ« -->
                <div class="setup-panel">
                    <h2>ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                    {% if debate.status == 'setup' %}
                        <div class="form-group">
                            <label>ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆã®ãƒ†ãƒ¼ãƒ</label>
                            <input type="text" id="theme" value="{{ debate.title }}" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>AIã‚¿ã‚¤ãƒ—</label>
                            <select id="ai_type" disabled style="background: #f0f0f0;">
                                <option value="{{ debate.ai_type }}" selected>
                                    {% if debate.ai_type == 'logical' %}
                                        è«–ç†çš„
                                    {% elif debate.ai_type == 'creative' %}
                                        å‰µé€ çš„
                                    {% elif debate.ai_type == 'diplomatic' %}
                                        å¤–äº¤çš„
                                    {% else %}
                                        æ”»æ’ƒçš„
                                    {% endif %}
                                </option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startDebate()">ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆé–‹å§‹</button>
                    {% else %}
                        <p style="color: #999;">
                            ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆé–‹å§‹å¾Œã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚
                        </p>
                    {% endif %}
                </div>

                <!-- ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
                <div class="debate-area">
                    <h2>ğŸ’¬ ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆ</h2>
                    <div id="positions-display" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
                        <div style="margin-bottom: 10px;"><strong>ğŸ‘¤ ã‚ãªãŸã®ç«‹å ´:</strong> <span id="user-position">èª­ã¿è¾¼ã¿ä¸­...</span></div>
                        <div><strong>ğŸ¤– AIã®ç«‹å ´:</strong> <span id="ai-position">èª­ã¿è¾¼ã¿ä¸­...</span></div>
                    </div>
                    <div class="speaking-indicator" id="speaking-indicator">
                        <div class="voice-icon">ğŸ™ï¸</div>
                        <div id="speaking-text">ç™ºè¨€ã‚’å‡¦ç†ä¸­...</div>
                        <button class="btn btn-stop" id="stop-recording-btn" onclick="stopUserListening()" style="display: none;">ğŸ›‘ ç™ºè¨€çµ‚äº†</button>
                    </div>
                    <div class="debate-messages" id="debate-messages"></div>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        const debateId = parseInt('{{ debate.id }}');
        const debateStatus = '{{ debate.status }}';
        const firstSpeaker = '{{ debate.first_speaker }}';
        const aiType = '{{ debate.ai_type }}';
        const theme = '{{ debate.title }}';
        const debateTitle = '{{ debate.title }}';
        const maxTurns = parseInt('{{ debate.max_turns }}');

        let statementOrder = 0;
        let debateStarted = false;
        
        // éŸ³å£°å…¥åŠ›é–¢é€£
        let mediaRecorder = null;
        let recognitionBuffer = [];
        let isListening = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ã®ç™ºè¨€ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            if (debateStatus !== 'setup') {
                loadDebateStatements();
            }
        });

        function loadDebateStatements() {
            fetch(`/debate/${debateId}/detail/`)
                .then(response => response.text())
                .then(html => {
                    // ã“ã“ã§ç™ºè¨€ã‚’æŠ½å‡ºãƒ»è¡¨ç¤º
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const statements = doc.querySelectorAll('.debate-statement');
                    
                    statements.forEach(stmt => {
                        const speaker = stmt.querySelector('.statement-speaker').textContent;
                        const text = stmt.querySelector('.statement-text').textContent;
                        displayStatement(speaker.includes('ãƒ¦ãƒ¼ã‚¶ãƒ¼') ? 'user' : 'ai', text);
                    });
                });
        }

        function startDebate() {
            console.log('startDebate() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            console.log('firstSpeaker:', firstSpeaker);
            console.log('debateStatus:', debateStatus);
            
            debateStarted = true;
            document.querySelector('.setup-panel').innerHTML = '<p style="color: #999;">â±ï¸ ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ...</p>';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('status-display').textContent = 'ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆä¸­';
            document.getElementById('status-message').className = 'status-message status-debating';
            document.getElementById('status-message').textContent = 'ğŸ¤ ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ';

            // ç«‹å ´ã‚’å–å¾—ã—ã¦è¡¨ç¤º
            fetch(`/debate/${debateId}/positions/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('user-position').textContent = data.user_position;
                    document.getElementById('ai-position').textContent = data.ai_position;
                    document.getElementById('positions-display').style.display = 'block';
                    console.log('ç«‹å ´ã‚’å‰²ã‚ŠæŒ¯ã‚Šã¾ã—ãŸ:', data);
                } else {
                    console.error('ç«‹å ´å‰²ã‚ŠæŒ¯ã‚Šã‚¨ãƒ©ãƒ¼:', data.message);
                }
            })
            .catch(error => {
                console.error('ç«‹å ´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });

            // AIãŒå…ˆæ”»ã®å ´åˆ
            if (firstSpeaker === 'ai') {
                console.log('AIãŒå…ˆæ”»ã§ã™ã€‚generateAIOpeningStatement() ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚');
                generateAIOpeningStatement();
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…ˆæ”»ã®å ´åˆï¼šè‡ªå‹•çš„ã«éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…ˆæ”»ã§ã™ã€‚è‡ªå‹•çš„ã«éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                // å°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹æ§˜ã«ã™ã‚‹
                setTimeout(() => startUserListening(), 100);
            }
        }

        function generateAIOpeningStatement() {
            showSpeakingIndicator('AIãŒæœ€åˆã®æ„è¦‹ã‚’è€ƒãˆã¦ã„ã¾ã™...');
            
            fetch(`/debate/${debateId}/ai-response/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    theme: theme,
                    user_statement: ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // saveStatement ã¯ Promise ã‚’è¿”ã™
                    return saveStatement('ai', data.response)
                        .then(() => {
                            displayStatement('ai', data.response);
                            hideSpeakingIndicator();
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…ˆæ”»ã§ãªã„å ´åˆã¯ã€è‡ªå‹•çš„ã«éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹
                            console.log('AIã®æœ€åˆã®æ„è¦‹ã‚’è¡¨ç¤ºã—ãŸã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã™');
                            setTimeout(() => startUserListening(), 500);
                        });
                } else {
                    throw new Error(data.message || 'AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('generateAIOpeningStatement Error:', error);
                hideSpeakingIndicator();
                showSpeakingIndicator('ğŸ˜Ÿ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                setTimeout(() => hideSpeakingIndicator(), 3000);
            });
        }

        function submitUserStatement() {
            console.log('submitUserStatement() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ¬„ã¯ãªã„ãŸã‚ã€ç›´æ¥å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã¯ãªã„
            return;
        }

        function submitUserStatementDirect(statement) {
            // æ–‡å­—èµ·ã“ã—å¾Œã®çµæœã‚’ç›´æ¥å—ã‘å–ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            console.log('submitUserStatementDirect() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ:', statement);
            if (!statement || !statement.trim()) {
                console.warn('ç©ºã®æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚Œã‚ˆã†ã¨ã—ã¾ã—ãŸ');
                startUserListening();
                return Promise.resolve();
            }

            // éŸ³å£°å…¥åŠ›ã‚’åœæ­¢
            if (isListening) {
                stopUserListening();
            }

            showSpeakingIndicator('ã‚ãªãŸã®æ„è¦‹ã‚’ä¿å­˜ä¸­...');
            
            return saveStatement('user', statement)
                .then(() => {
                    displayStatement('user', statement);
                    showSpeakingIndicator('AIãŒå¿œç­”ã‚’è€ƒãˆã¦ã„ã¾ã™...');
                    return getAIResponse(statement);
                })
                .then(aiResponse => {
                    if (aiResponse) {
                        return saveStatement('ai', aiResponse)
                            .then(() => {
                                displayStatement('ai', aiResponse);
                            });
                    }
                })
                .then(() => {
                    hideSpeakingIndicator();
                    
                    // æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã®ãŸã‚éŸ³å£°å…¥åŠ›ã‚’å†é–‹
                    // è¨­å®šã•ã‚ŒãŸæœ€å¤§ã‚¿ãƒ¼ãƒ³æ•°ã«é”ã—ãŸã‹ç¢ºèª
                    // maxTurnsã‚’ä¸Šå›ã‚‹åº¦æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼+AIå„ã‚¿ãƒ¼ãƒ³ï¼‰ã§è¨ˆç®—
                    const totalTurns = maxTurns * 2;
                    if (statementOrder >= totalTurns) {
                        // æ¬¡ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã™ã‚‹ä»£ã‚ã‚Šã«åˆ¤å®šé¸æŠç”»é¢ã‚’è¡¨ç¤º
                        showFinishOption();
                    } else {
                        // æ¬¡ã®ã‚¿ã‚¿ãƒ¼ãƒ³ã‚’ç¶šã‘ã‚‹
                        setTimeout(() => startUserListening(), 500);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideSpeakingIndicator();
                    showSpeakingIndicator('ğŸ˜Ÿ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    setTimeout(() => hideSpeakingIndicator(), 3000);
                });
        }

        function saveStatement(speaker, text) {
            return fetch(`/debate/${debateId}/statement/add/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    speaker: speaker,
                    text: text
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statementOrder = data.order;
                } else {
                    throw new Error(data.message);
                }
            });
        }

        function getAIResponse(userStatement) {
            return fetch(`/debate/${debateId}/ai-response/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    theme: theme,
                    user_statement: userStatement
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    return data.response;
                } else {
                    throw new Error(data.message);
                }
            });
        }

        function displayStatement(speaker, text) {
            const messagesDiv = document.getElementById('debate-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${speaker}`;
            
            const speakerDisplay = speaker === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AI';
            messageDiv.innerHTML = `
                <div class="message-speaker">${speakerDisplay}</div>
                <div class="message-text">${escapeHtml(text)}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showFinishOption() {
            const messagesDiv = document.getElementById('debate-messages');
            const finishDiv = document.createElement('div');
            finishDiv.style.cssText = 'text-align: center; padding: 20px; margin-top: 20px;';
            finishDiv.innerHTML = `
                <p style="margin-bottom: 10px; color: #666;">
                    ååˆ†ãªãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆãŒè¡Œã‚ã‚Œã¾ã—ãŸã€‚çµæœã‚’åˆ¤å®šã—ã¾ã™ã‹ï¼Ÿ
                </p>
                <button class="btn btn-primary" onclick="finishDebate()" style="width: auto; padding: 10px 30px;">
                    ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆçµ‚äº† & åˆ¤å®š
                </button>
            `;
            messagesDiv.appendChild(finishDiv);
        }

        function finishDebate() {
            if (confirm('ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆã‚’çµ‚äº†ã—ã¦åˆ¤å®šã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ')) {
                // éŸ³å£°å…¥åŠ›ã‚’åœæ­¢
                if (isListening) {
                    stopUserListening();
                }
                
                showSpeakingIndicator('AIãŒå‹æ•—ã‚’åˆ¤å®šä¸­...');
                
                fetch(`/debate/${debateId}/judge/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        hideSpeakingIndicator();
                        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çµæœã‚’è¡¨ç¤º
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideSpeakingIndicator();
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                });
            }
        }

        function showSpeakingIndicator(text, showStopButton = false) {
            document.getElementById('speaking-text').textContent = text;
            document.getElementById('speaking-indicator').classList.add('active');
            const stopBtn = document.getElementById('stop-recording-btn');
            if (stopBtn) {
                stopBtn.style.display = showStopButton ? 'block' : 'none';
            }
        }

        function hideSpeakingIndicator() {
            document.getElementById('speaking-indicator').classList.remove('active');
        }

        async function startUserListening() {
            if (isListening) {
                console.log('æ—¢ã«éŸ³å£°å…¥åŠ›ä¸­ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
                return;
            }
            
            console.log('startUserListening() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            
            // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            if (mediaRecorder && mediaRecorder.stream) {
                console.log('æ—¢å­˜ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™');
                mediaRecorder.stream.getTracks().forEach(track => {
                    console.log('ãƒˆãƒ©ãƒƒã‚¯ã‚’ã‚¯ãƒ­ãƒ¼ã‚º:', track.kind);
                    track.stop();
                });
            }
            
            try {
                console.log('getUserMedia() ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
                showSpeakingIndicator('ğŸ¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°ã‚’éŒ²éŸ³ä¸­...', true);
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });

                console.log('ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ:', stream);
                console.log('ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒˆãƒ©ãƒƒã‚¯æ•°:', stream.getTracks().length);
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                console.log('MediaRecorder ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ:', mediaRecorder);

                recognitionBuffer = [];

                mediaRecorder.ondataavailable = (event) => {
                    console.log('ondataavailable ã‚¤ãƒ™ãƒ³ãƒˆ:', event.data.size, 'bytes');
                    if (event.data.size > 0) {
                        recognitionBuffer.push(event.data);
                    }
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder ã‚¨ãƒ©ãƒ¼:', event.error);
                };

                mediaRecorder.onstop = async () => {
                    console.log('onstop ã‚¤ãƒ™ãƒ³ãƒˆã€ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º:', recognitionBuffer.length);
                    const audioBlob = new Blob(recognitionBuffer, { type: 'audio/webm' });
                    console.log('Blobä½œæˆ:', audioBlob.size, 'bytes');
                    await processAudioInput(audioBlob);
                };

                console.log('mediaRecorder.start(500) ã‚’å‘¼ã³å‡ºã—ä¸­...');
                mediaRecorder.start(500);
                isListening = true;
                console.log('éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                showSpeakingIndicator('ğŸ¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°ã‚’éŒ²éŸ³ä¸­...', true);

            } catch (error) {
                console.error('startUserListening ã‚¨ãƒ©ãƒ¼:', error.name, error.message, error);
                hideSpeakingIndicator();
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç¶šè¡Œã•ã›ã‚‹
                if (error.name === 'NotAllowedError') {
                    console.warn('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
                    // ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const button = document.getElementById('mic-btn');
                    if (button) button.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯ã§è©±ã™';
                } else if (error.name === 'NotFoundError') {
                    console.warn('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
                    const button = document.getElementById('mic-btn');
                    if (button) button.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯ã§è©±ã™';
                }
            }
        }

        function stopUserListening() {
            if (!isListening) return;
            if (mediaRecorder) {
                console.log('éŸ³å£°å…¥åŠ›ã‚’æ­¢ã‚ã¾ã™');
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isListening = false;
                document.getElementById('stop-recording-btn').style.display = 'none';
            }
        }

        function startUserListeningManual() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ã€Œãƒã‚¤ã‚¯ã§è©±ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå ´åˆ
            const button = document.getElementById('mic-btn');
            if (isListening) {
                stopUserListening();
                button.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯ã§è©±ã™';
                return;
            }
            
            button.textContent = 'â¹ï¸ éŒ²éŸ³åœæ­¢';
            startUserListening();
        }

        async function processAudioInput(audioBlob) {
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦æ–‡å­—èµ·ã“ã—ã‚’è¡Œã†
            try {
                console.log('éŸ³å£°ãƒ–ãƒ­ãƒ–ã‚µã‚¤ã‚º:', audioBlob.size, 'bytes');
                
                if (audioBlob.size === 0) {
                    console.warn('éŸ³å£°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    const textBox = document.getElementById('user-statement');
                    if (textBox) textBox.value = '';
                    hideSpeakingIndicator();
                    // æ¬¡ã®å…¥åŠ›ã®ãŸã‚ã«å†åº¦ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹
                    setTimeout(() => startUserListening(), 1000);
                    return;
                }
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                console.log('æ–‡å­—èµ·ã“ã—APIã«é€ä¿¡ä¸­...');
                const response = await fetch('/debate/transcribe/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData
                });

                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹Content-Type:', response.headers.get('content-type'));
                
                // JSONã®ã¿ã‚’å—ã‘å…¥ã‚Œã‚‹
                if (!response.headers.get('content-type').includes('application/json')) {
                    throw new Error('æ–‡å­—èµ·ã“ã—APIãŒJSONå½¢å¼ã§å¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + response.status);
                }

                const data = await response.json();
                console.log('æ–‡å­—èµ·ã“ã—å¿œç­”:', data);
                
                if (data.text && data.text.trim().length > 0) {
                    console.log('èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ:', data.text);
                    hideSpeakingIndicator();
                    // èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥é€ä¿¡
                    await submitUserStatementDirect(data.text);
                } else {
                    console.log('éŸ³å£°ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å†åº¦ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                    hideSpeakingIndicator();
                    // æ¬¡ã®å…¥åŠ›ã®ãŸã‚ã«å†åº¦ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹
                    setTimeout(() => startUserListening(), 1000);
                }
            } catch (error) {
                console.error('éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error.message, error);
                hideSpeakingIndicator();
                
                // æ–‡å­—èµ·ã“ã—APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ä¿ƒã™
                if (error.message.includes('JSON')) {
                    console.warn('æ–‡å­—èµ·ã“ã—ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                    showSpeakingIndicator('ğŸ¤ æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼');
                    setTimeout(() => hideSpeakingIndicator(), 3000);
                }
                
                // æ¬¡ã®å…¥åŠ›ã®ãŸã‚ã«å†åº¦ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹
                setTimeout(() => startUserListening(), 1000);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
